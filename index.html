<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ki·ªÉm tra gi√° s·∫£n ph·∫©m BNSG</title>

<style>
body {
  font-family: Arial, sans-serif;
  padding: 16px;
}

h2 {
  margin-top: 0;
}

/* CAMERA */
.camera-input {
  margin-bottom: 12px;
}

/* INPUT + BUTTON ROW */
.manual-row {
  display: flex;
  gap: 6px;
  margin-bottom: 12px;
}

.manual-row input,
.manual-row button {
  box-sizing: border-box;
  height: 44px;
  font-size: 16px;
}

.manual-row input {
  flex: 1;
  padding: 8px;
}

.manual-row button {
  white-space: nowrap;
  padding: 0 12px;
}

/* RESULT */
.result {
  margin-top: 12px;
}

.price {
  font-size: 28px;
  font-weight: bold;
  color: #d32f2f;
  margin-top: 6px;
}

#msg {
  margin-top: 6px;
}

/* ACTION BUTTONS */
.actions {
  margin-top: 14px;
}

.actions button {
  width: 100%;
  height: 44px;
  font-size: 16px;
  margin-top: 8px;
}
</style>
</head>

<body>

<h2>Ki·ªÉm tra gi√° s·∫£n ph·∫©m BNSG</h2>

<!-- CAMERA -->
<div class="camera-input">
  <input
    type="file"
    accept="image/*"
    capture="environment"
    onchange="scanImage(this.files[0])"
  />
</div>

<!-- MANUAL INPUT -->
<div class="manual-row">
  <input
    id="manual"
    placeholder="Nh·∫≠p m√£ v·∫°ch"
    inputmode="numeric"
  />
  <button onclick="lookupManual()">Ki·ªÉm tra gi√° b√°n</button>
</div>

<!-- RESULT -->
<div class="result" id="result">
  <div>M√£: <span id="ean">-</span></div>
  <div>T√™n: <span id="name">-</span></div>
  <div class="price" id="price">-</div>
  <div id="msg"></div>
</div>

<!-- ACTIONS -->
<div class="actions">
  <button onclick="captureScreen()">üì∏ Ch·ª•p m√†n h√¨nh k·∫øt qu·∫£</button>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
const API_URL =
  "https://script.google.com/macros/s/AKfycbw-Qhp1D8B28HFUoRAPYvh-56i2_nIckGB7SuggxmTjWyVJNjzlB70EQ6mUbZwGem_bWw/exec";

const input = document.getElementById("manual");

function formatVND(v) {
  return Number(v).toLocaleString("vi-VN") + " VNƒê";
}

// üîä Beep khi t√¨m th·∫•y
function beep() {
  new Audio(
    "https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"
  ).play();
}

// üì∑ QU√âT ·∫¢NH BARCODE
async function scanImage(file) {
  const reader = new ZXing.BrowserBarcodeReader();
  const img = URL.createObjectURL(file);

  try {
    const result = await reader.decodeFromImageUrl(img);
    lookup(result.text);
  } catch (e) {
    document.getElementById("msg").innerText =
      "‚ùå Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c m√£ ‚Äì vui l√≤ng nh·∫≠p tay";
  }
}

// ‚å®Ô∏è NH·∫¨P TAY (N√öT)
function lookupManual() {
  const ean = input.value.trim();
  if (/^\d{13}$/.test(ean)) {
    lookup(ean);
  }
}

// ‚å®Ô∏è ENTER / GO ‚Üí tra lu√¥n
input.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    lookupManual();
  }
});

// üîé LOOKUP CH√çNH
async function lookup(ean) {
  document.getElementById("ean").innerText = ean;
  document.getElementById("msg").innerText = "ƒêang ki·ªÉm tra...";

  try {
    const res = await fetch(API_URL + "?ean=" + ean);
    const data = await res.json();

    if (data.ok) {
      document.getElementById("name").innerText = data.name;
      document.getElementById("price").innerText = formatVND(data.price);
      document.getElementById("msg").innerText = "‚úîÔ∏è ƒê√£ t√¨m th·∫•y";
      beep();
    } else {
      document.getElementById("name").innerText = "-";
      document.getElementById("price").innerText = "-";
      document.getElementById("msg").innerText = "‚ùå Kh√¥ng t√¨m th·∫•y";
    }
  } catch (err) {
    document.getElementById("msg").innerText = "‚ö†Ô∏è L·ªói k·∫øt n·ªëi";
  }

  // UX nhanh
  input.value = "";
  input.focus();
}

// üì∏ CH·ª§P M√ÄN H√åNH K·∫æT QU·∫¢
function captureScreen() {
  const target = document.getElementById("result");

  html2canvas(target).then(canvas => {
    const link = document.createElement("a");
    link.download = "gia-san-pham.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  });
}

// focus s·∫µn khi m·ªü trang
input.focus();
</script>

</body>
</html>
