<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Check gi√° s·∫£n ph·∫©m BNSG</title>

<style>
body {
  font-family: Arial, sans-serif;
  padding: 16px;
}
.price {
  font-size: 26px;
  font-weight: bold;
  color: #d32f2f;
  margin-top: 6px;
}
input, button {
  padding: 10px;
  font-size: 16px;
}
button {
  margin-left: 6px;
}
</style>
</head>

<body>

<h2>Ki·ªÉm tra gi√° s·∫£n ph·∫©m BNSG</h2>

<!-- C√ÅCH 1: CAMERA -->
<input
  type="file"
  accept="image/*"
  capture="environment"
  onchange="scanImage(this.files[0])"
/>

<hr>

<!-- C√ÅCH 2: NH·∫¨P TAY -->
<input
  id="manual"
  placeholder="Nh·∫≠p m√£ v·∫°ch"
  inputmode="numeric"
/>
<button onclick="lookupManual()">Ki·ªÉm tra gi√° b√°n</button>

<hr>

<div>M√£: <span id="ean">-</span></div>
<div>T√™n: <span id="name">-</span></div>
<div class="price" id="price">-</div>
<div id="msg"></div>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
const API_URL =
  "https://script.google.com/macros/s/AKfycbw-Qhp1D8B28HFUoRAPYvh-56i2_nIckGB7SuggxmTjWyVJNjzlB70EQ6mUbZwGem_bWw/exec";

const input = document.getElementById("manual");

function formatVND(v) {
  return Number(v).toLocaleString("vi-VN") + " VNƒê";
}

// üîä Beep khi lookup th√†nh c√¥ng
function beep() {
  const audio = new Audio(
    "https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"
  );
  audio.play();
}

// üöÄ QU√âT T·ª™ ·∫¢NH
async function scanImage(file) {
  const reader = new ZXing.BrowserBarcodeReader();
  const img = URL.createObjectURL(file);

  try {
    const result = await reader.decodeFromImageUrl(img);
    lookup(result.text);
  } catch (e) {
    document.getElementById("msg").innerText =
      "‚ùå Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c m√£ ‚Äì vui l√≤ng nh·∫≠p tay";
  }
}

// ‚å®Ô∏è NH·∫¨P TAY (N√öT)
function lookupManual() {
  const ean = input.value.trim();
  if (/^\d{13}$/.test(ean)) {
    lookup(ean);
  }
}

// ‚å®Ô∏è ENTER / GO ‚Üí lookup lu√¥n
input.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    lookupManual();
  }
});

// üéØ LOOKUP CH√çNH
async function lookup(ean) {
  document.getElementById("ean").innerText = ean;
  document.getElementById("msg").innerText = "ƒêang ki·ªÉm tra...";

  try {
    const res = await fetch(API_URL + "?ean=" + ean);
    const data = await res.json();

    if (data.ok) {
      document.getElementById("name").innerText = data.name;
      document.getElementById("price").innerText = formatVND(data.price);
      document.getElementById("msg").innerText = "‚úîÔ∏è ƒê√£ t√¨m th·∫•y";
      beep();
    } else {
      document.getElementById("name").innerText = "-";
      document.getElementById("price").innerText = "-";
      document.getElementById("msg").innerText = "‚ùå Kh√¥ng t√¨m th·∫•y";
    }
  } catch (err) {
    document.getElementById("msg").innerText = "‚ö†Ô∏è L·ªói k·∫øt n·ªëi";
  }

  // ‚ö° UX nhanh: t·ª± clear + focus
  input.value = "";
  input.focus();
}

// focus s·∫µn khi m·ªü trang
input.focus();
</script>

</body>
</html>
